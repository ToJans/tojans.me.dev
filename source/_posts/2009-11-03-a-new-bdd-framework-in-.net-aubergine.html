---
layout: post
title: ! 'A new BDD framework in .Net : Aubergine'
---

<h3>Update !! this has changed a lot</h3>
<p>&nbsp;</p>
<p><a href="http://www.corebvba.be/blog/post/A-new-BDD-framework-in-Net-NetSpec-3d3e-Aubergine.aspx">Check this post !!!</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>Introduction</h3>
<p>During my exploration of <a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development" target="_blank">BDD</a> frameworks for .NET&nbsp; I only had one final runner-up as a BDD framework : <a href="http://codebetter.com/blogs/aaron.jensen/archive/2008/09/02/mspec-v0-2.aspx" target="_blank">Machine.Specifications</a> . This is a very nice framework, but in my quest for the holy grail on BDD it got me started on thinking about an even better BDD framework. In this article I will layout my initial ideas about a BDD framework named Aubergine.</p>
<p>&nbsp;</p>
<h3>Likes and dislikes about MSpec</h3>
<p>MSpec is in my personal opinion one of the best BDD frameworks available for .Net, due to the very nice syntax.</p>
<p>An example :</p>
<p>First I'll show you the account class :</p>
<p><div class="code">
<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> Account<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> Decimal Balance {get;set;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">void</span> Transfer(<span class="kwrd">decimal</span> amount,Account ToAccount)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">if</span> (Balance &lt; amount)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">throw</span> <span class="kwrd">new</span> ArgumentOutOfRangeException(<span class="str">"There is not enough money available on the account"</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Balance-=amount;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ToAccount.Balance+=amount;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /></div></p>
<p>Next up I will show you the specs in Mspec :</p>
<p><div class="code">
</p>
<p><span class="kwrd">using</span> System;<br />&nbsp;<br /><span class="kwrd">namespace</span> Machine.Specifications.Example<br />{<br />[Subject(<span class="kwrd">typeof</span>(Account), <span class="str">"Funds transfer"</span>)]<br />&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> when_transferring_between_two_accounts<br />&nbsp;&nbsp;&nbsp; : with_from_account_and_to_account<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; Because of = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fromAccount.Transfer(1m, toAccount);<br />&nbsp;<br />&nbsp;&nbsp;&nbsp; It should_debit_the_from_account_by_the_amount_transferred = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fromAccount.Balance.ShouldEqual(0m);<br />&nbsp;<br />&nbsp;&nbsp;&nbsp; It should_credit_the_to_account_by_the_amount_transferred = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toAccount.Balance.ShouldEqual(2m);<br />&nbsp; }<br />&nbsp;<br />[Subject(<span class="kwrd">typeof</span>(Account), <span class="str">"Funds transfer"</span>), Tags(<span class="str">"failure"</span>)]<br />&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> when_transferring_an_amount_larger_than_the_balance_of_the_from_account<br />&nbsp;&nbsp;&nbsp; : with_from_account_and_to_account<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">static</span> Exception exception;<br />&nbsp;&nbsp;&nbsp; Because of =()=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exception = Catch.Exception(()=&gt;fromAccount.Transfer(2m, toAccount));<br />&nbsp;<br />&nbsp;&nbsp;&nbsp; It should_not_allow_the_transfer =()=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exception.ShouldBeOfType&lt;Exception&gt;();<br />&nbsp; }<br />&nbsp;<br />&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> failure {}<br />&nbsp;<br />&nbsp; <span class="kwrd">public</span> <span class="kwrd">abstract</span> <span class="kwrd">class</span> with_from_account_and_to_account<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">protected</span> <span class="kwrd">static</span> Account fromAccount;<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">protected</span> <span class="kwrd">static</span> Account toAccount;<br />&nbsp;<br />&nbsp;&nbsp;&nbsp; Establish context =()=&gt;<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fromAccount = <span class="kwrd">new</span> Account {Balance = 1m};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toAccount = <span class="kwrd">new</span> Account {Balance = 1m};<br />&nbsp;&nbsp;&nbsp; };<br />&nbsp; }<br />}<br /></div></p>
<p>While this is a very keen and intelligent approach there are a few things that I am not very fond of :</p>
<ul>
<li>The "Subject" attribute : is really code litter, and not really acceptable IMHO</li>
<li>The fact that we use classes and subclasses for each scenario; sometimes this becomes too much of a hassle; your code gets split up into several places, and this is not very transparent anymore...</li>
<li>The lack of Story support</li>
<li>The catching of expected exceptions should not need a try catch block but have some kind of other mechanism.<br /><strong>Edit: My bad;there is a mechanism in MSpec... However, I'm not a real fan of it, since it is in the because part. IMHO this should be an "it", not a "because"<br /></strong></li>
<li>The fact that the context is intermixed with the class itself =&gt; this might be a subject of discussion, but it is certainly not my personal preference; I prefer a seperate context class per story and/or scenario</li>
<li>Some definitions, i.e. "because of", "Establish","It" etc... are not good enough in my opinion</li>
<li>The use of underscores; I am more of a PascalCasing fan<br /><strong>Edit: After the remark of Aaron, I decided to implement both</strong></li>
</ul>
<p>Based on my ideas I created a new BDD Framework : NetSpec</p>
<p>&nbsp;</p>
<h3>The Aubergine approach</h3>
<p>Based on my findings I started coding this morning, and this is the spec defined in NetSpec :</p>
<p><div class="code">
<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">class</span> TransferFundsBetweenAccounts : Story<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AsAn AccountUser;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IWant ToTransferMoneyBetweenAccounts;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SoThat ICanHaveRealUseForMyMoney;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">class</span> Transfer1MBetweenTwoAccounts : Scenario&amp;lt;Context&amp;gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Given BothAccountsHave1M = () =&gt; <span class="kwrd">new</span> Context(1m,1m);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; When Transfering1MFromAToB = c =&gt; c.AccountA.Transfer(1m,c.AccountB);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ItShould Have0mOnAccountA = c =&gt; c.AccountA.Balance.ShouldEqual(0m);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ItShould Have2mOnAccountB = c =&gt; c.AccountB.Balance.ShouldEqual(2m);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">class</span> TransferTooMuch : Scenario&amp;lt;Context&amp;gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Given BothAccountsHave1M = () =&gt; <span class="kwrd">new</span> Context(1m, 1m);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; When Transfering2MFromAToB = c =&gt; c.AccountA.Transfer(2m,c.AccountB);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ItShould Have1mOnAccountA = c =&gt; c.AccountA.Balance.ShouldEqual(1m);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ItShould Have1mOnAccountB = c =&gt; c.AccountB.Balance.ShouldEqual(1m);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ItShouldFailWithError AmountToLarge = e =&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.ShouldBeOfType&amp;lt;ArgumentOutOfRangeException&amp;gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> Context<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> Context(<span class="kwrd">decimal</span> amounta, <span class="kwrd">decimal</span> amountb)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AccountA.Balance = amounta;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AccountB.Balance = amountb;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> Account AccountA = <span class="kwrd">new</span> Account();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> Account AccountB = <span class="kwrd">new</span> Account();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /></div></p>
<p>&nbsp;</p>
<p><strong>Edit : After Aaron's remarks I replaced</strong></p>
<p><div class="code">
<br /> ItShouldThrowException&amp;lt;ArgumentOutOfRangeException&amp;gt; AmountToHigh;<br /> </div></p>
<p><strong>with</strong></p>
<p><div class="code">
<br /> ItShouldFailWithError AmountToLarge = e =&gt; e.ShouldBeOfType&amp;lt;ArgumentOutOfRangeException&amp;gt;();<br /> </div></p>
<p><strong>which is closer to the domain expert's language then the developer's.</strong></p>
<p>Now, I do not know what You think, but in my opinion this is a lot more readable then the MSpec version.</p>
<p>While the code currently compiles, the testing itself is not implemented yet, but this should not be such a big hurdle. The automatic catching of the exception should only happen in the "When"-phase afaik, other exceptions should ALWAYS return a fail.</p>
<p>&nbsp;</p>
<h3>Conclusion</h3>
<p>In my quest for the holy grail I have met a lot of hurdles but I do think I am getting closer to my target. I hope/think that a domain expert should be able to read the code I present in the specifications; In my opinion this should be a viable DSL-like human-readable text. While the current representation still has some constraints due to it's implementation language, most of the disturbing stuff has been left out.</p>
<p>Up next is the implementation of the testrunner, but I will have to take a look at my schedule when I will be able to complete this, since I sometimes have to do some work that pays the bills as well ;) ...</p>
<p>If you have any suggestions or remarks please do let me know in the comment section !!</p><div style="text-align:right"><a class="addthis_button" href="http://www.addthis.com/bookmark.php?v=250&amp;pub=xa-4aec37702e3161d4"><img src="http://s7.addthis.com/static/btn/v2/lg-share-en.gif" width="125" height="16" alt="Bookmark and Share" style="border:0"/></a><script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pub=xa-4aec37702e3161d4"></script></div>
