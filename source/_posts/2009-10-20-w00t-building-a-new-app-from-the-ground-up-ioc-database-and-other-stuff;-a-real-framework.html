---
layout: post
title: ! 'w00t : Building a new app from the ground up : IOC, database and other stuff;
  a real framework'
---

<p>This is one of the articles in our series; the parts are:</p>
<ol>
<li><a href="http://www.corebvba.be/blog/post/w00t-Building-a-new-app-from-the-ground-up-methodology-technology-tools-used.aspx">Methodology, technology &amp; tools used</a></li>
<li><a href="http://www.corebvba.be/blog/post/w00t-Building-a-new-app-from-the-ground-up-setting-up-the-environment.aspx">Setting up the environment</a></li>
<li><a href="http://www.corebvba.be/blog/post/w00t-Building-a-new-app-from-the-ground-up-First-specs-and-getting-started.aspx">First specs and getting started</a></li>
<li><a href="http://www.corebvba.be/blog/post/w00t-Building-a-new-app-from-the-ground-up-IOC-database-and-other-stuff3b-a-real-framework.aspx">IOC, database and other stuff; a real framework</a>&nbsp; </li>
</ol>
<p>&nbsp;Happy reading !</p>
<h2>Finally a framework ! <br /></h2>
<p class="MsoNormal">&nbsp;When I went to bed last night, I was thinking about a few things, so I said to myself : "Ok, I'll quickly implement them". But, as one can expect, a few minutes became a few hours, so in the end I did not get much sleep. I decided to finish it this morning, so the now the main stuff of the framework is finsished, and I'll write a little post about this.</p>
<p class="MsoNormal">&nbsp;</p>
<h2 class="MsoNormal">Back to the drawing board <br /></h2>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">After taking a closer look at simplerepository to know the domain model conventions I noticed that the support for relationships was a mess (i.e. you have to join data yourself using Id's etc, so I decided to go back to the one thing I know : fluent nhibernate.</span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">In the mean time my specs were constantly evolving&hellip; It lead me to do a complete refactoring of my code; you can see the current state of the spec in the end :</span></p>
<p class="MsoNormal">&nbsp;</p>
<h2 class="MsoNormal">Delete subsonic and get FluentNhibernate, Nhibernate.Linq and Castle.Windsor <br /></h2>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">1. In the project folder, delete the folder "SubSonic-3.0"<br />2. Start a git bash in the project folder, and type :<br />git clone git://github.com/jagregory/fluent-nhibernate.git<br />3. look for fluentnhbernate.csproj and build it (make sure the configuration mode is set to release)<br />4. look for machine.Specifications.sln and build it<br />5. Change the batch file tools\copydependenciesandtools.cmd to the following :&nbsp;</span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">@Echo off<br />echo.<br />echo<span>&nbsp;&nbsp; </span>Copying all tools and dependencies<br />echo.<br />copy ..\machine.Specifications\Build\Release\*.dll<br />copy ..\machine.Specifications\Build\Release\*.exe<br />copy ..\machine.Specifications\Build\Release\*.dll ..\lib\*.*<br />copy ..\fluent-nhibernate\src\FluentNHibernate\bin\Release\*.dll ..\lib\*.*<br />pause <br />6. execute tools\copydependenciesandtools.cmd<br />7. execute tools\cleanup.Cmd<br />8. Download <a href="http://sourceforge.net/projects/castleproject/files/InversionOfControl/2.0/Castle-Windsor-2.0.zip/download" target="_blank">Castle.Windsor</a> for IOC and put the dll&rsquo;s in the lib folder<br />9. Download <a href="http://sourceforge.net/projects/nhibernate/files/NHibernate/2.1.0.GA/NHibernate.Linq-1.0.0.GA-bin.zip/download" target="_blank">NHibernate.Linq</a> and put the dll&rsquo;s in the lib folder</span></p>
<h2 class="MsoNormal">Setup your business logic project</h2>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">11. Creat a new class lib project and name it &ldquo;xxx.Core&rdquo;<br />12. Add references to the following libs in both your specs project and your Core project :<br />..\lib\Castle.Core<br />..\lib\Castle.MicroKernel<br />..\lib\Castle.Windsor<br />..\lib\FluentNHibernate<br />..\lib\NHibernate<br />..\lib\NHibernate.ByteCode.Castle<br />..\lib\NHibernate.Linq<br />..\lib\System.Data.SqlLite<br />..\lib\System.Data.SqlLite.Linq</span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">Add the core project as a <span>&nbsp;</span>ref to your specs project .</span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: 'Courier New'">13. Create your model classes according to the fluentnhbibernate conventions. An example :</span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: 'Courier New'"><div class="code">
<br />&nbsp; // models\_ModelBase.cs<br />//<br />// the <span class="kwrd">abstract</span> <span class="kwrd">base</span> <span class="kwrd">class</span> <span class="kwrd">for</span> the domain objects<br />//<br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Models<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">abstract</span> <span class="kwrd">class</span> ModelBase<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">int</span> Id {get;set;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">string</span> Description { get; set; }<br />&nbsp;&nbsp;&nbsp; }<br />}<br />// models\Product.cs<br />//<br />// a product<br />//<br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Models<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> Product : ModelBase<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">int</span> Number { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> ProductGroup Group { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">bool</span> Available { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">bool</span> PrintOutToReceipt { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">bool</span> PrintOutToKitchen { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">string</span> CourseName { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">bool</span> NonProfit { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> ICollection&lt;Lookup&gt; Lookups { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">int</span> SellingPrice1 { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">int</span> SellingPrice2 { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">int</span> SellingPrice3 { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">int</span> SellingPrice4 { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> <span class="kwrd">int</span> SellingPrice5 { get; set; }<br />&nbsp;&nbsp;&nbsp; }<br />}</span><span style=<span class="str">"font-size: 10pt; font-family: 'Courier New'"</span>><br /></div><br /></span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">14. After this I created the interfaces in the core project :<br /><div class="code">
<br />// Interfaces \ IIOC.cs<br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Interfaces<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">interface</span> IIOC<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T Resolve&lt;T&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T Resolve&lt;T&gt;(<span class="kwrd">string</span> name);<br />&nbsp;&nbsp;&nbsp; }<br />}<br />// interfaces\IRepository.cs<br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Interfaces<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">interface</span> IRepository&lt;T&gt; <span class="kwrd">where</span> T:Models.ModelBase<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T GetById(<span class="kwrd">int</span> id);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IQueryable&lt;T&gt; Find { get; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">void</span> SaveOrUpdate(T instance);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">void</span> Delete(T instance);<br />&nbsp;&nbsp;&nbsp; }<br />}<br />// interfaces\IUnitOfWork.cs<br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Interfaces<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">interface</span> IUnitOfWork : IDisposable<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">void</span> Commit();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dictionary&lt;<span class="kwrd">string</span>, <span class="kwrd">object</span>&gt; SessionVars { get; }<br />&nbsp;&nbsp;&nbsp; }<br />}<br />// interfaces\IUnitOfWorkFactory.cs<br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Interfaces<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">interface</span> IUnitOfWorkFactory<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IUnitOfWork CurrentUnitOfWork {get;}<br />&nbsp;&nbsp;&nbsp; }<br />}<br />// interfaces\IUnitOfWorkFactory.cs<br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Interfaces<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">interface</span> IXmlAdapter<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">void</span> Import(<span class="kwrd">string</span> xml);<br />&nbsp;&nbsp;&nbsp; }<br />}</span><span style=<span class="str">"font-size: 10pt; font-family: 'Courier New'"</span>><br /></div></span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: 'Courier New'">15. Implement concrete classes that implement the interfaces </span><br /><br /><span style="font-size: 10pt; font-family: 'Courier New'"><div class="code">
<br />//implementations\database.cs<br />//<br />// Automaticly creates an sqllite db based on the classes <span class="kwrd">in</span> the Models <span class="kwrd">namespace</span>.<br />//<br /><span class="kwrd">using</span> System;<br /><span class="kwrd">using</span> System.Collections.Generic;<br /><span class="kwrd">using</span> System.Linq;<br /><span class="kwrd">using</span> System.Text;<br /><span class="kwrd">using</span> NHibernate;<br /><span class="kwrd">using</span> FluentNHibernate;<br /><span class="kwrd">using</span> FluentNHibernate.Cfg;<br /><span class="kwrd">using</span> FluentNHibernate.Cfg.Db;<br /><span class="kwrd">using</span> FluentNHibernate.Automapping;<br /><span class="kwrd">using</span> Be.HorecaTouch.Core.Models;<br /><span class="kwrd">using</span> Be.HorecaTouch.Core.Services.Interfaces;<br /><span class="kwrd">using</span> NHibernate.Tool.hbm2ddl; <br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Implementations<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">abstract</span> <span class="kwrd">class</span> Database : IUnitOfWorkFactory<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">protected</span> ISessionFactory SessionFactory;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">protected</span> <span class="kwrd">static</span> ISession LocalSession; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">protected</span> Database(IPersistenceConfigurer pcfg)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var cfg = Fluently.Configure()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Database(pcfg)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Mappings(m =&gt; m.AutoMappings.Add(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AutoMap.AssemblyOf&lt;Product&gt;()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .IgnoreBase&lt;ModelBase&gt;()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Where(am =&gt; am.Namespace == <span class="kwrd">typeof</span>(Product).Namespace)))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .BuildConfiguration();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SessionFactory = cfg.BuildSessionFactory();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalSession = SessionFactory.OpenSession();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">new</span> SchemaExport(cfg).Execute(<span class="kwrd">false</span>, <span class="kwrd">true</span>, <span class="kwrd">false</span>, LocalSession.Connection, <span class="kwrd">null</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />&nbsp;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="preproc">#region</span> IUnitOfWorkFactory Members<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">virtual</span> IUnitOfWork CurrentUnitOfWork<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalSession = <span class="kwrd">null</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">return</span> <span class="kwrd">new</span> UnitOfWork(()=&gt;SessionFactory.OpenSession(),<span class="kwrd">true</span>,<span class="kwrd">false</span> );<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="preproc">#endregion</span> <br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> SqlLiteInMemoryDatabase : Database<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> SqlLiteInMemoryDatabase() : <span class="kwrd">base</span>(SQLiteConfiguration.Standard.InMemory())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">override</span> IUnitOfWork CurrentUnitOfWork<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">return</span> <span class="kwrd">new</span> UnitOfWork(() =&gt; LocalSession, <span class="kwrd">false</span>, <span class="kwrd">true</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> SqlLiteDatabase : Database<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> SqlLiteDatabase(<span class="kwrd">string</span> filename) : <span class="kwrd">base</span>(SQLiteConfiguration.Standard.UsingFile(filename))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">override</span> IUnitOfWork CurrentUnitOfWork<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">return</span> <span class="kwrd">new</span> UnitOfWork(() =&gt; SessionFactory.OpenSession(), <span class="kwrd">false</span>, <span class="kwrd">false</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />}<br />// implementations\IOC.cs<br />//<br />// use the <span class="kwrd">default</span> castle windsor IOC container<br />//<br /><span class="kwrd">using</span> Be.HorecaTouch.Core.Services.Interfaces; <br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Implementations<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> IOC : Castle.Windsor.WindsorContainer, IIOC {}<br />}<br />// implementations\Repository<br />//<br />// a generic repository <span class="kwrd">for</span> nhibernate<br />//<br /><span class="kwrd">using</span> System;<br /><span class="kwrd">using</span> System.Collections.Generic;<br /><span class="kwrd">using</span> System.Linq;<br /><span class="kwrd">using</span> System.Text;<br /><span class="kwrd">using</span> Be.HorecaTouch.Core.Services.Interfaces;<br /><span class="kwrd">using</span> FluentNHibernate;<br /><span class="kwrd">using</span> NHibernate.Linq;<br /><br /><span class="kwrd">namespace</span> Be.HorecaTouch.Core.Services.Implementations<br />{<br /><br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> Repository&lt;T&gt; : IRepository&lt;T&gt; <span class="kwrd">where</span> T:Models.ModelBase<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NHibernate.ISession session; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> Repository(Database db)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session = ((UnitOfWork)db.CurrentUnitOfWork).Session.Instance&nbsp; ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="preproc">#region</span> IRepository&lt;T&gt; Members <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> T GetById(<span class="kwrd">int</span> id)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">return</span> session.Get&lt;T&gt;(id);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> IQueryable&lt;T&gt; Find<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { <span class="kwrd">return</span> session.Linq&lt;T&gt;(); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">void</span> SaveOrUpdate(T instance)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.SaveOrUpdate(instance);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">void</span> Delete(T instance)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.Delete(instance);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br />&nbsp;&nbsp;&nbsp; }<br />}<br /></div></span></p>
<h2>So what is the Result until now ?</h2>
<p class="MsoNormal">Now you have a fully setup environment with an (inmemory/file) database for your domainmodel,&nbsp; acessible with a generic iRepository. All your service interfaces are available through an IOC, and your data can be easily persisted&hellip;</p>
<p class="MsoNormal">Your development can now also be driven by specs</p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial">Adjust the spec file to your likings;this is currently mine :</span></p>
<p class="MsoNormal"><span style="font-size: 10pt; font-family: Arial"><div class="code">
<br /><span class="kwrd">using</span> System;<br /><span class="kwrd">using</span> System.Collections.Generic;<br /><span class="kwrd">using</span> System.Linq;<br /><span class="kwrd">using</span> System.Text;<br /><span class="kwrd">using</span> Machine.Specifications;<br /><span class="kwrd">using</span> Be.HorecaTouch.Core.Models;<br /><span class="kwrd">using</span> Be.HorecaTouch.Core.Services.Interfaces;<br /><span class="kwrd">using</span> Be.HorecaTouch.Core.Services.Implementations; <br /><span class="kwrd">namespace</span> Specs<br />{<br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">abstract</span> <span class="kwrd">class</span> with_empty_database<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="kwrd">protected</span> <span class="kwrd">static</span> IIOC ioc; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Establish context = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var cont = <span class="kwrd">new</span> IOC();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cont.AddComponent&lt;Database, SqlLiteInMemoryDatabase&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cont.AddComponent&lt;IRepository&lt;Product&gt;,Repository&lt;Product&gt;&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cont.AddComponent&lt;IRepository&lt;Lookup&gt;, Repository&lt;Lookup&gt;&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cont.AddComponent&lt;IXmlAdapter, XmlAdapter&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ioc = cont;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">class</span> when_products_are_imported_from_external_xmlfile : with_empty_database<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Because of = () =&gt; ioc.Resolve&lt;IXmlAdapter&gt;().Import(Properties.Resources.ExternalProductsXml);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; It should_contain_multiple_products = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ioc.Resolve&lt;IRepository&lt;Product&gt;&gt;().Find.Count().ShouldBeGreaterThan(0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; It should_have_a_product_called_steak_with_cooking_and_sauce_lookups = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ioc.Resolve&lt;IRepository&lt;Product&gt;&gt;().Find<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Where(a =&gt; a.Description == <span class="str">"Steak"</span>).Count().ShouldBeGreaterThan(0); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; It should_contain_multiple_lookups = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ioc.Resolve&lt;IRepository&lt;Lookup&gt;&gt;().Find.Count().ShouldBeGreaterThan(0);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; It should_contain_multiple_cookings;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; It should_contain_multiple_courses;<br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; <span class="kwrd">public</span> <span class="kwrd">abstract</span> <span class="kwrd">class</span> with_filled_database : with_empty_database<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Establish context = () =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ioc.Resolve&lt;IXmlAdapter&gt;().Import(Properties.Resources.ExternalProductsXml);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br />&nbsp;&nbsp;&nbsp; }<br /></span><span style=<span class="str">"font-size: 10pt; font-family: Arial"</span>>}<br /></div><br /></span></p>
<p class="MsoNormal">Finally, this is what my current Spec build html looks like :</p>
<h1><span style="font-family: Arial">Specs&nbsp;&nbsp;&nbsp;&nbsp;</span></h1>
<h2><span style="font-family: Arial; color: lightgrey">1 concern, 1 context, 5 specifications, </span><span class="notimplemented1"><span style="font-family: Arial">2 not implemented specs</span></span><span style="font-family: Arial; color: lightgrey"> </span></h2>
<p class="MsoNormal"><span style="font-size: 11pt; font-family: Arial">&nbsp;</span></p>
<div class="MsoNormal" style="text-align: center"><span style="font-size: 11pt; font-family: Arial">
<hr size="1" />
</span></div>
<div class="MsoNormal" style="text-align: center"><span style="font-size: 11pt; font-family: Arial">
<hr size="1" />
</span></div>
<h2><span style="font-family: Arial">specifications&nbsp;&nbsp;&nbsp;&nbsp;</span></h2>
<h3><span class="count1"><span style="font-family: Arial">1 context, 5 specifications, </span></span><span class="notimplemented1"><span style="font-family: Arial">2 not implemented specs</span></span></h3>
<h3><span style="font-family: Arial">when products are imported from external xmlfile&nbsp;&nbsp;&nbsp;&nbsp;</span></h3>
<h4><span class="count1"><span style="font-family: Arial">5 specifications, </span></span><span class="notimplemented1"><span style="font-family: Arial">2 not implemented specs</span></span></h4>
<p class="MsoNormal" style="margin-left: 36pt">&nbsp;</p>
<ul>
<li class="MsoNormal"><span style="font-size: 11pt; font-family: Arial">should contain multiple products </span></li>
<li class="MsoNormal"><span style="font-size: 11pt; font-family: Arial">should have a product called steak with cooking and sauce lookups </span></li>
<li class="MsoNormal"><span style="font-size: 11pt; font-family: Arial">should contain multiple lookups </span></li>
<li class="MsoNormal"><span style="font-size: 11pt; font-family: Arial">should contain multiple cookings</span><strong><span style="font-size: 11pt; font-family: Arial; color: orange">&lt; NOT IMPLEMENTED</span></strong> <span style="font-size: 11pt; font-family: Arial"><br /></span></li>
<li class="MsoNormal"><span style="font-size: 11pt; font-family: Arial">should contain multiple courses</span><strong><span style="font-size: 11pt; font-family: Arial; color: orange">&lt; NOT IMPLEMENTED</span></strong><span style="font-size: 11pt; font-family: Arial"> <br /></span></li>
</ul>
<p class="MsoNormal" style="margin-left: 36pt">&nbsp;</p>
<div class="MsoNormal" style="text-align: center"><span style="font-size: 11pt; font-family: Arial">
<hr size="1" />
</span></div>
<h2 class="MsoNormal">Conclusion <br /></h2>
<p class="MsoNormal">Et voila, in a few easy steps we have created a framework which offers quite some advantages, and should be easy to extend... and is BDD (hype hype hype !!) I do not offer the holy grail however, so always make sure you adapt the code to your wishes.</p>
<p class="MsoNormal">Since blogging about this does take quite some time, and the development now becomes really specific, I think this will probably be my last post about this new project, but he, never say never !!!</p>
<p class="MsoNormal">Maybe if I have some issues regarding MVC testing I might blog about it, but I can not guarantee anything... Happy coding !!&lt;--&gt;</p><div style="text-align:right"><a class="addthis_button" href="http://www.addthis.com/bookmark.php?v=250&amp;pub=xa-4aec37702e3161d4"><img src="http://s7.addthis.com/static/btn/v2/lg-share-en.gif" width="125" height="16" alt="Bookmark and Share" style="border:0"/></a><script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pub=xa-4aec37702e3161d4"></script></div>
